name: redis

project_files:
  - docker-compose.redis.yaml
  - redis/scripts/settings.ddev.redis.php
  - redis/scripts/setup-drupal-settings.php
  - redis/scripts/setup-redis-optimized-config.php
  - redis/redis.conf
  - redis/advanced.conf
  - redis/append.conf
  - redis/general.conf
  - redis/io.conf
  - redis/memory.conf
  - redis/network.conf
  - redis/security.conf
  - redis/snapshots.conf
  - commands/host/redis-backend
  - commands/redis/redis-cli
  - commands/redis/redis-flush

# TODO: we will want a version constraint but it will be higher than this.
#ddev_version_constraint: '>= v1.24.3'

post_install_actions:
  - |
    <?php
    #ddev-description:Install redis settings for Drupal 9+ if applicable
    include '/mnt/ddev_config/redis/scripts/setup-drupal-settings.php';
    ?>
  - |
    <?php
    #ddev-description:Using optimized config if --redis-optimized=true
    include '/mnt/ddev_config/redis/scripts/setup-redis-optimized-config.php';
    ?>
  - |
    <?php
    #ddev-description:Remove redis/scripts if there are no files
    $scriptsDir = '/mnt/ddev_config/redis/scripts';
    if (is_dir($scriptsDir)) {
        $files = array_diff(scandir($scriptsDir), ['.', '..']);
        if (empty($files)) {
            rmdir($scriptsDir);
        }
    }
    ?>
  - |
    <?php
    #ddev-description:Remove old `redis` command from `ddev-redis-7`
    $oldCommand = '/var/www/html/.ddev/commands/redis/redis';
    if (file_exists($oldCommand) && 
        strpos(file_get_contents($oldCommand), '#ddev-generated') !== false) {
        unlink($oldCommand);
    }
    ?>

removal_actions:
  - |
    <?php
    #ddev-description:Remove redis settings if applicable
    
    // Read DDEV configuration to get docroot
    $config = yaml_parse_file('/mnt/ddev_config/config.yaml');
    $docroot = $config['docroot'] ?? 'web';
    
    // Files to potentially remove
    $filesToCheck = [
        "/var/www/html/{$docroot}/sites/default/settings.ddev.redis.php",
        "/var/www/html/.ddev/docker-compose.redis_extra.yaml"
    ];
    
    foreach ($filesToCheck as $file) {
        if (file_exists($file)) {
            $content = file_get_contents($file);
            if (strpos($content, '#ddev-generated') !== false) {
                unlink($file);
            } else {
                echo "Unwilling to remove '$file' because it does not have #ddev-generated in it; you can manually delete it if it is safe to delete.\n";
            }
        }
    }
    ?>